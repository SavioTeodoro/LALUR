SELECT SUM(MOV.VLRDEP) AS VLRDEP_FISCAL, 
    SUM(MOVAJ.VLRDEP) AS VLRDEP_SOCIETARIA,
    SUM(MOV.VLRDEP) - SUM(MOVAJ.VLRDEP) AS DIFAC,
    CASE WHEN (SUM(MOV.VLRDEP) - SUM(MOVAJ.VLRDEP)) > 0 THEN 'D' ELSE 'C' END AS DC
FROM 
    TCIBEM BEM
LEFT JOIN 
    TGFPRO PRO ON PRO.CODPROD = BEM.CODPROD
LEFT JOIN 
    TGFGRU GRU ON GRU.CODGRUPOPROD = PRO.CODGRUPOPROD
LEFT JOIN 
    TCIMOV MOV ON MOV.CODBEM = BEM.CODBEM AND MOV.CODPROD = BEM.CODPROD
LEFT JOIN 
    TCIMOVAJ MOVAJ ON MOVAJ.CODBEM = BEM.CODBEM AND MOVAJ.CODPROD = BEM.CODPROD
LEFT JOIN 
    TCITAX TAX ON TAX.CODPROD = BEM.CODPROD AND TAX.CODBEM = BEM.CODBEM 
LEFT JOIN 
    TCITAXAJ TAXAJ ON TAXAJ.CODPROD = BEM.CODPROD AND TAXAJ.CODBEM = BEM.CODBEM
WHERE  BEM.CODEMP IN (1, 2)
    AND BEM.DTCOMPRA <= '30/01/2024'
    AND NVL(MOV.REFERENCIA,'30/01/2024') <= '30/01/2024'
    AND (BEM.DTBAIXA IS NULL OR 
    BEM.DTBAIXA > '30/01/2024')
    AND BEM.CODBEM NOT LIKE '<TODOS>'
