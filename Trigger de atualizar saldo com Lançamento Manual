CREATE OR REPLACE TRIGGER AD_TRG_UPD_TCBLALSAL 
AFTER INSERT ON AD_TCBSALLAN 

FOR EACH ROW DECLARE 

 V_SALDOSOMA NUMBER; -- Declare a variável para armazenar o resultado do cálculo 
 V_NATINI VARCHAR2(1); -- Declara o tipo de saldo 
 BEGIN 



  IF :NEW.MANUAL = 'S' THEN

  SELECT  NATINI INTO V_NATINI
  FROM AD_TCBLALSAL
  WHERE REFERENCIA = :NEW.REFERENCIA
  AND CONTAPARTEB = :NEW.CONTAPARTEB; 

    DELETE FROM AD_TCBSALLAN_PROV;

    INSERT INTO AD_TCBSALLAN_PROV (CONTAPARTEB, REFERENCIA, DC, VALOR, TIPOIMPOSTO)
    VALUES (:NEW.CONTAPARTEB, :NEW.REFERENCIA, :NEW.DC, :NEW.VALOR, :NEW.TIPOIMPOSTO);

      IF V_NATINI = 'D' THEN 

        SELECT NVL(SUM(CASE WHEN DC = 'D' THEN VALOR ELSE VALOR*-1 END),0) INTO V_SALDOSOMA
        FROM AD_TCBSALLAN_PROV
        WHERE REFERENCIA = :NEW.REFERENCIA 
          AND CONTAPARTEB = :NEW.CONTAPARTEB
          AND TIPOIMPOSTO = 'I';

        UPDATE AD_TCBLALSAL 
        SET SALDOFIN = SALDOFIN + V_SALDOSOMA 
        WHERE REFERENCIA = :NEW.REFERENCIA 
          AND CONTAPARTEB = :NEW.CONTAPARTEB;

      END IF; 

      IF V_NATINI = 'C' THEN 

        SELECT NVL(SUM(CASE WHEN DC = 'D' THEN VALOR*-1 ELSE VALOR END),0) INTO V_SALDOSOMA
        FROM AD_TCBSALLAN_PROV
        WHERE REFERENCIA = :NEW.REFERENCIA 
          AND CONTAPARTEB = :NEW.CONTAPARTEB
          AND TIPOIMPOSTO = 'I'; 

        UPDATE AD_TCBLALSAL 
        SET SALDOFIN = SALDOFIN + V_SALDOSOMA 
        WHERE REFERENCIA = :NEW.REFERENCIA 
          AND CONTAPARTEB = :NEW.CONTAPARTEB; 

      END IF; 

  END IF; 
END; 


/
